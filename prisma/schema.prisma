generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Campus {
  id           String   @id @default(cuid())
  name         String
  shortName    String
  logo         String?
  location     String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  batches      Batch[]
  departments  Department[]
  users        User[]
  quizzes      Quiz[]
  assessments  Assessment[]
  registrationCodes RegistrationCode[]

  @@map("campuses")
}

model Batch {
  id        String   @id @default(cuid())
  name      String   // e.g., "2014-2018"
  campusId String
  campus    Campus   @relation(fields: [campusId], references: [id], onDelete: Cascade)
  users     User[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  registrationCodes RegistrationCode[]

  @@map("batches")
}

model Department {
  id       String @id @default(cuid())
  name     String
  campusId String
  campus   Campus @relation(fields: [campusId], references: [id], onDelete: Cascade)
  users    User[]
  registrationCodes RegistrationCode[]

  @@map("departments")
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  name                 String?
  password             String
  role                 UserRole           @default(USER)
  avatar               String?
  phone                String?
  section              StudentSection     @default(A)
  campusId             String?
  campus               Campus?            @relation(fields: [campusId], references: [id])
  departmentId         String?
  department           Department?        @relation(fields: [departmentId], references: [id])
  batchId              String?
  batch                Batch?             @relation(fields: [batchId], references: [id])
  registrationCodeId    String?
  registrationCode     RegistrationCode? @relation(fields: [registrationCodeId], references: [id])
  isActive             Boolean            @default(true)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  quizAttempts         QuizAttempt[]
  quizUsers            QuizUser[]
  assessmentAttempts   AssessmentAttempt[]
  assessmentUsers      AssessmentUser[]
  tabSwitches         AssessmentTabSwitch[]
  quizTabSwitches     QuizTabSwitch[]
  createdQuizzes       Quiz[]             @relation("QuizCreator")
  createdAssessments   Assessment[]       @relation("AssessmentCreator")
  questionGroups       QuestionGroup[]
  reportedQuestions    ReportedQuestion[]

  @@map("users")
}

model QuestionGroup {
  id          String     @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  questions   Question[]
  creatorId   String
  creator     User       @relation(fields: [creatorId], references: [id])

  @@map("question_groups")
}

model Question {
  id            String          @id @default(cuid())
  title         String
  content       String
  type          QuestionType
  options       String
  correctAnswer String
  explanation   String?
  difficulty    DifficultyLevel @default(MEDIUM)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  quizQuestions       QuizQuestion[]
  assessmentQuestions AssessmentQuestion[]
  groupId             String
  group               QuestionGroup? @relation(fields: [groupId], references: [id])
  reportedQuestions   ReportedQuestion[]

  @@map("questions")
}

model Quiz {
  id                 String          @id @default(cuid())
  title              String
  description        String?
  timeLimit          Int?
  difficulty         DifficultyLevel @default(MEDIUM)
  status             QuizStatus      @default(ACTIVE)
  negativeMarking    Boolean         @default(false)
  negativePoints     Float?
  randomOrder        Boolean         @default(false)
  maxAttempts        Int?
  showAnswers        Boolean         @default(false)
  startTime          DateTime?
  endTime            DateTime?
  creatorId          String
  campusId           String?
  campus             Campus?         @relation(fields: [campusId], references: [id])
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  quizAttempts       QuizAttempt[]
  quizQuestions      QuizQuestion[]
  quizTabSwitches QuizTabSwitch[]
  quizUsers          QuizUser[]
  creator            User            @relation("QuizCreator", fields: [creatorId], references: [id])
  checkAnswerEnabled Boolean         @default(false)

  @@map("quizzes")
}

model QuizQuestion {
  id         String   @id @default(cuid())
  quizId     String
  questionId String
  order      Int
  points     Float    @default(1.0)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  quiz       Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([quizId, questionId])
  @@map("quiz_questions")
}

model QuizUser {
  id        String   @id @default(cuid())
  quizId    String
  userId    String
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([quizId, userId])
  @@map("quiz_users")
}

model QuizAttempt {
  id          String        @id @default(cuid())
  userId      String
  quizId      String
  status      AttemptStatus @default(NOT_STARTED)
  score       Float?
  totalPoints Float?
  timeTaken   Int?
  startedAt   DateTime?
  submittedAt   DateTime?
  isAutoSubmitted Boolean          @default(false)
  createdAt     DateTime          @default(now())
  updatedAt   DateTime      @updatedAt
  answers     QuizAnswer[]
  quiz        Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizTabSwitches QuizTabSwitch[]

  @@map("quiz_attempts")
}

model QuizAnswer {
  id           String      @id @default(cuid())
  attemptId    String
  questionId   String
  userAnswer   String
  isCorrect    Boolean?
  pointsEarned Float?
  timeSpent    Int?
  createdAt    DateTime    @default(now())
  attempt      QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("quiz_answers")
}

model Assessment {
  id                 String          @id @default(cuid())
  title              String
  description        String?
  timeLimit          Int?
  difficulty         DifficultyLevel @default(MEDIUM)
  status             QuizStatus      @default(ACTIVE)
  negativeMarking    Boolean         @default(false)
  negativePoints     Float?
  randomOrder        Boolean         @default(false)
  startTime          DateTime?
  creatorId          String
  campusId           String?
  campus             Campus?         @relation(fields: [campusId], references: [id])
  maxTabs            Int?
  disableCopyPaste   Boolean         @default(false)
  accessKey          String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  assessmentAttempts AssessmentAttempt[]
  assessmentQuestions AssessmentQuestion[]
  assessmentUsers    AssessmentUser[]
  tabSwitches       AssessmentTabSwitch[]
  creator            User            @relation("AssessmentCreator", fields: [creatorId], references: [id])

  @@map("assessments")
}

model AssessmentQuestion {
  id            String      @id @default(cuid())
  assessmentId  String
  questionId    String
  order         Int
  points        Float       @default(1.0)
  question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  assessment    Assessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, questionId])
  @@map("assessment_questions")
}

model AssessmentUser {
  id            String      @id @default(cuid())
  assessmentId  String
  userId        String
  createdAt     DateTime @default(now())
  assessment    Assessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, userId])
  @@map("assessment_users")
}

model AssessmentAttempt {
  id            String           @id @default(cuid())
  userId        String
  assessmentId  String
  status        AttemptStatus    @default(NOT_STARTED)
  score         Float?
  totalPoints   Float?
  timeTaken     Int?
  startedAt     DateTime?
  submittedAt    DateTime?
  isAutoSubmitted Boolean          @default(false)
  createdAt      DateTime          @default(now())
  updatedAt     DateTime         @updatedAt
  answers       AssessmentAnswer[]
  assessment    Assessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  tabSwitches     AssessmentTabSwitch[]
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("assessment_attempts")
}

model AssessmentAnswer {
  id             String      @id @default(cuid())
  attemptId      String
  questionId     String
  userAnswer     String
  isCorrect      Boolean?
  pointsEarned   Float?
  timeSpent      Int?
  createdAt      DateTime    @default(now())
  attempt        AssessmentAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("assessment_answers")
}

model ReportedQuestion {
  id           String           @id @default(cuid())
  questionId   String
  userId       String
  suggestion   String
  status       ReportStatus     @default(PENDING)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  question     Question         @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reported_questions")
}

model Settings {
  id                String   @id @default(cuid())
  siteTitle         String   @default("Atom Q")
  siteDescription   String   @default("Take quizzes and test your knowledge")
  maintenanceMode   Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("settings")
}

model RegistrationSettings {
  id                String   @id @default(cuid())
  allowRegistration Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("registration_settings")
}

model RegistrationCode {
  id          String   @id @default(cuid())
  code        String   @unique
  expiry      DateTime
  campusId    String?
  campus      Campus?   @relation(fields: [campusId], references: [id])
  departmentId String?
  department  Department?   @relation(fields: [departmentId], references: [id])
  batchId     String?
  batch       Batch?   @relation(fields: [batchId], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  users       User[]

  @@map("registration_codes")
}

enum UserRole {
  USER
  ADMIN
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_BLANK
  MULTI_SELECT
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum QuizStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum AttemptStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum StudentSection {
  A
  B
  C
  D
  E
  F
}

model AssessmentTabSwitch {
  id            String   @id @default(cuid())
  attemptId     String
  userId        String
  assessmentId   String
  createdAt      DateTime @default(now())
  attempt        AssessmentAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id])
  assessment    Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  @@map("assessment_tab_switches")
}

model QuizTabSwitch {
  id            String   @id @default(cuid())
  attemptId     String
  userId        String
  quizId        String
  createdAt      DateTime @default(now())
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id])
  quiz          Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@map("quiz_tab_switches")
}
